# Cache替换算法

## 运行环境搭建

实验内容部分来自[Cache Replacement Championship](https://www.jilp.org/jwac-1/)。实验采用该赛事提供的模拟器来运行和测试Cache替换算法。模拟器的使用参考提供的文档`./bin/README`。运行模拟器需要较低版本的OS 内核。目前已知模拟器可以在 Ubuntu 10.04 运行，不能在 Ubuntu 14.04运行，其它系统对模拟器的支持情况还不清楚。Ubuntu 10.04 的虚拟机配置以及运行模拟器的依赖库参考`Vagrantfile`。

## DRRIP算法实现

模拟器在./src/LLCsim/replacement_state.h 和replacement_state.cpp文件中默认实现了LRU和Random替换策略。本次实验另外了实现DRRIP替换算法。DRRIP算法来自给出的两篇paper。

DRRIP策略在每一个cache行设置一个计数器来存储这些行的Re-Reference Interval Prediction (RRPV)值。RRIP值代表预测某一cache块被重新调用的次序。。在RRIP链的前端，表示该cache块很快会被再次调用， 而在RRIP链的后端则表示该cache块被再次调用的间隔会很久。DRRIP策略使用Set Dueling 机制在SRRIP策略和BRRIP策略之间动态选择一种更好地策略应用到下一次替换中， 以此来减少发生缺失的次数。

1） SRRIP策略

如果一个cache块间隔很久才会被调用， 那么就有可能引起cache的高缺失率，低cache的使用率。为了阻止那些再次调用间隔很久的cache块污染cache，SRRIP策略在每个cache块中使用M bits来存储该块的RRPV值。RRPV值会随着每个块被调用的频率动态变化。对于本实验，设置M的值为2。RRPV值等于 ‘0’ ， 说明该cache块最近被调用过， 而且预测处理器很快会再次调用该cache块； RRPV值等于 ‘3’，说明该cache块最近没有被调用过，而且处理器在短时间内不会再次调用该cache块；RRPV值等于 ‘1’ 或者‘2’时，说明该cache块会有较高的可能性被调用。在初始情况下，所有的cache块的RRPV值都等于‘3’。一旦cache命中，该cache块的RRPV值就被设置成‘0’；相反地，一旦cache发生缺失，SRRIP策略会选择再次调用间隔很久的cache块进行替换，首先查找RRPV值为‘3’的cache块进行替换，并将其RRPV值设置成‘2’，如果没有找到RRPV值为‘3’的cache块，就将所有cache块的RRPV值加1后再进行查找，直到找到RRPV值为‘3’的cache块。

2） DRRIP策略

为了避免cache冲突以及适应不同种类的工作集，BRRIP策略在低概率下将新cache块替换到RRPV值为 ‘2’ 的块，用参数ε来表示这个概率值，设定ε = 1/32，即在32次插入新行的情况下，有31次插入RRPV值为‘3’的位置，1次插入RRPV值为‘2’的位置。但是对于不存在cache冲突的存取模式，总是使用BRRIP策略是有害无益的。所以通过使用Set Dueling机制在SRRIP策略和BRRIP策略之间进行动态选择，基于历史信息选择发生较少缺失的策略应用到其他cache块。

DRRIP根据策略选择器变量PS的值来选择策略。PS能够追踪SRRIP和BRRIP之间哪一个发生的缺失更少。如果SRRIP发生一次缺失，PS加1，相反地，如果BRRIP发生一次缺失，PS减1。PS的值能够指示哪一种策略发生更少的缺失。如果PS的值等于1，那么使用BRRIP策略，否则使用SRRIP策略。

## 运行与测试

运行build.sh将对/traces文件夹下的trace进行测试，测试结果输出在/runs文件夹下，可解压查看。测试文件可从[链接](https://pan.baidu.com/s/1Zg7iocMMJW4mfpkt6qogAA)获取, 提取码09f7。trace文件的生成以及运行时策略的选择参考/bins/README。

除了测试程序给出的性能指标，测试时利用Linux下time命令记录每个程序的运行时间，在输出的real user sys中选用real作为运行时间的性能度量。实验中将time命令的结果重定向到result.out文件中，并采用process.py脚本对运行的输出结果做统计处理，process.py将各个程序在不同策略下的性能指标进行统计比较，以表格的形式输出到readme.md中，即在“运行结果”中看到的表格。

## 运行结果

| **Program** | **LRU_time** | **LRU_CPI** | **LRU_miss** | **Random_time** | **Random_CPI** | **Random_miss** | **DRRIP_time** | **DRRIP_CPI** | **DRRIP_miss** | **least_time** | **least_CPI** | **least_miss** |
| ----: | -------: | ----: | ----: | -------: | ----: | ----: | -------: | ----: | ----: | -------: | ----: | ----: |
| perlbench | 35.29 | 0.642823 | 40.7952 | 37.06 | 0.665731 | 44.4057 | 36.47 | 0.649961 | 41.9563 | LRU | LRU | LRU |
| bzip2 | 244.21 | 0.554642 | 61.7369 | 149.02 | 0.561004 | 61.6783 | 176.19 | 0.555696 | 61.1119 | Random | LRU | DRRIP |
| gcc | 175.49 | 0.614864 | 42.7521 | 169.15 | 0.632975 | 45.6397 | 163.03 | 0.576204 | 37.0117 | DRRIP | DRRIP | DRRIP |
| bwaves | 160.17 | 0.253088 | 99.6634 | 151.84 | 0.253088 | 99.6634 | 147.47 | 0.253088 | 99.6634 | DRRIP | -- | -- |
| gamess | 158.66 | 0.30022 | 26.3204 | 162.47 | 0.302997 | 27.6546 | 152.70 | 0.302972 | 28.2432 | DRRIP | LRU | LRU |
| mcf | 193.76 | 2.55358 | 75.676 | 183.26 | 2.5574 | 76.6152 | 180.66 | 1.8474 | 55.9727 | DRRIP | DRRIP | DRRIP |
| milc | 162.96 | 1.14939 | 77.0164 | 162.92 | 1.14819 | 76.2749 | 161.27 | 1.15432 | 77.1799 | DRRIP | LRU | Random |
| zeusmp | 143.88 | 0.451633 | 80.81 | 145.55 | 0.454491 | 82.6395 | 140.57 | 0.451381 | 80.7558 | DRRIP | DRRIP | DRRIP |
| gromacs | 158.67 | 0.607769 | 71.1979 | 159.33 | 0.623448 | 74.3719 | 161.55 | 0.615708 | 72.6502 | LRU | LRU | LRU |
| cactusADM | 152.47 | 0.44249 | 76.1164 | 149.74 | 0.436016 | 73.7824 | 156.22 | 0.366023 | 64.8184 | Random | DRRIP | DRRIP |
| leslie3d | 169.18 | 1.50626 | 84.0284 | 159.51 | 1.52591 | 80.9639 | 158.91 | 1.50759 | 81.2131 | DRRIP | LRU | Random |
| namd | 138.18 | 0.273795 | 66.2603 | 135.43 | 0.273805 | 66.3123 | 136.51 | 0.273795 | 66.2545 | Random | LRU | DRRIP |
| gobmk | 157.89 | 0.383876 | 14.919 | 165.63 | 0.406574 | 20.4838 | 158.03 | 0.381858 | 13.8269 | LRU | DRRIP | DRRIP |
| dealII | 166.93 | 0.463916 | 45.0892 | 163.59 | 0.449077 | 41.7856 | 167.09 | 0.441832 | 38.3708 | Random | DRRIP | DRRIP |
| soplex | 94.30 | 0.356909 | 15.2011 | 88.45 | 0.366572 | 17.5536 | 90.90 | 0.361154 | 16.2963 | Random | LRU | LRU |
| povray | 171.35 | 0.360431 | 39.9258 | 171.69 | 0.360522 | 40.2017 | 166.94 | 0.360407 | 39.8444 | DRRIP | DRRIP | DRRIP |
| calculix | 155.51 | 0.321346 | 34.05 | 160.38 | 0.330771 | 38.3193 | 156.63 | 0.324732 | 36.7343 | LRU | LRU | LRU |
| hmmer | 166.34 | 0.258513 | 71.4736 | 166.04 | 0.258513 | 71.4736 | 166.14 | 0.258511 | 71.4605 | Random | DRRIP | DRRIP |
| sjeng | 163.07 | 0.323006 | 93.5415 | 158.76 | 0.323338 | 94.1036 | 161.55 | 0.322837 | 93.2422 | Random | DRRIP | DRRIP |
| GemsFDTD | 162.10 | 0.368143 | 84.1525 | 163.88 | 0.368143 | 84.1525 | 163.19 | 0.368143 | 84.1525 | LRU | -- | -- |
| libquantum | 166.81 | 0.272749 | 100 | 157.88 | 0.272749 | 100 | 159.42 | 0.272749 | 100 | Random | -- | -- |
| h264ref | 153.62 | 0.28787 | 70.0086 | 155.20 | 0.291897 | 71.7721 | 152.17 | 0.288128 | 70.1401 | DRRIP | LRU | LRU |
| tonto | 139.21 | 0.347856 | 78.8694 | 135.14 | 0.348094 | 79.4314 | 136.88 | 0.347863 | 78.898 | Random | LRU | LRU |
| lbm | 167.44 | 1.15379 | 99.9725 | 163.95 | 1.15435 | 99.9385 | 165.08 | 1.15317 | 99.8661 | Random | DRRIP | DRRIP |
| omnetpp | 169.37 | 0.41278 | 59.4443 | 164.32 | 0.412934 | 60.0557 | 168.21 | 0.412739 | 59.3187 | Random | DRRIP | DRRIP |
| astar | 159.10 | 0.267647 | 5.84718 | 158.47 | 0.267647 | 5.84718 | 157.81 | 0.267647 | 5.84718 | DRRIP | -- | -- |
| sphinx3 | 162.89 | 0.445644 | 97.156 | 159.91 | 0.445665 | 97.262 | 159.32 | 0.445645 | 97.1648 | DRRIP | LRU | LRU |
| xalancbmk | 165.05 | 0.414993 | 66.2759 | 163.66 | 0.420899 | 67.5795 | 165.49 | 0.413111 | 65.1721 | Random | DRRIP | DRRIP |
| specrand | 94.08 | 0.336211 | 95.9373 | 96.11 | 0.336246 | 96.3212 | 93.17 | 0.336293 | 96.929 | DRRIP | LRU | LRU |

从运行结果看出，DRRIP策略相比LRU策略在大部分程序中都在CPI和缺失率上有所提升，少数程序是LRU的性能较好。有几个程序在三种策略下的缺失率都较高，接近或达到了100%，对这些程序需要进行针对性的分析和设计。在运行时间这个指标上，不少程序出现了和CPI与缺失率上的不一致，这里的时间是由Linux下time命令给出的用户时间和系统时间之和，作为性能指标可能存在一些不稳定因素。